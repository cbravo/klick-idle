<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>KlickIdle</title>

    <!-- bootstrap minified CSS -->
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">

	<script src='https://cdn.firebase.com/js/client/1.0.15/firebase.js'></script>
	<!-- <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script> -->
    <script src='http://code.jquery.com/jquery-2.1.1.min.js'></script>
</head>
<body>
    <div id="loader" style="display:none;"></div>
    <div class="header">
        <div class="container">
            <div class="row">
                <div class="col-xs-12 clearfix">
                    <div class="left">
                        <img src="images/klickheader.gif" height="50" width="142" alt="Klick Health" />
                    </div>
                    <div class="right">
                        <img src="images/toplogo.gif" height="50" width="36" alt="Klick Health" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="global-alerts" style="display:none;" class="section">
        <div class="container">
            <div class="row">    
                <div class="col-xs-12">
                    <div class="alert-container"></div>
                </div>
            </div>
        </div>
    </div>


    <div class="main-content section">
        <div class="container">
            <div class="row">    
                <div class="col-xs-12 col-sm-8 col-md-7 col-lg-5">
                    <div id="currentuser" class="user" style="display:none;">
                        <div class="alert alert-success" role="alert">Status successfully updated!</div>
                        <h2>Your Current Status:</h2>
                        <form class="details-container" action="">    
                        </form>                      
                        <button class="btn1" onclick="KlickIdle.firebase.updateUser(); return false;">Update Status</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
	<script>
        var KlickIdle =  (function(app){

            app.firebase = app.firebase || {};
            app.genome = app.genome || {};

            //configuration default settings
            app.config = {
                'loader' : '#loader',
                'firebaseUrl' : 'https://klickidle.firebaseio.com/',
                'genomeUrl' : 'http://genome.klick.com:80',
                'someOtherSetting' : 10
            };

            //initialize the app
            app.init = function() {
                initGenome();
                initFirebase();
                setupBindings();
                
                app.genome.getCurrentUser();
                app.firebase.getIdleUsers();
            }

            //establish connection with Genome
            function initGenome(){
                //set up genome variables from config;
                app.genome.url = app.config.genomeUrl;
                app.genome.currentUser = {};

                //get current user from genome
                app.genome.getCurrentUser = function(){
                    //make ajax call to genome
                    startAjaxLoad();
                    var call = requestJSON(app.genome.url+'/api/User/Current.json');
                    console.log(call);
                    call.error(function(data){
                        createGlobalAlert('error', '<strong>Failed to make contact with Genome.</strong> Log into Genome before using Klick Idle!');
                    })
                    call.success(function(data){
                        checkIfUserExistsInFirebase(data);
                    });


                    //check if current user exists in firebase and if they are add data from firebase
                    function checkIfUserExistsInFirebase(data){
                        app.genome.currentUser = data.Entries[0];
                        var user = app.genome.currentUser;
                        
                        app.firebase.users.child(user.UserID).once('value', function(snapshot) {
                            if (snapshot.val() !== null){
                                var firebaseData = snapshot.val();
                                app.genome.currentUser.Status = user.Status = firebaseData.Status;
                                app.genome.currentUser.Message = user.Message = firebaseData.Message;
                                app.genome.currentUser.TimeStamp = user.TimeStamp = firebaseData.TimeStamp;
                            }
                            populateCurrentUserData(user); 
                        });
                    }
                    
                    function populateCurrentUserData(user){
                        console.log(user);
                        var userDetailsText = '';
                        userDetailsText += '<div class=" form-group clearfix">\n';
                            userDetailsText += '<input type="hidden" name="UserID" value="'+ user.UserID +'" />\n';
                            userDetailsText += '<input type="hidden" name="FirstName" value="'+ user.FirstName  +'" />\n';
                            userDetailsText += '<input type="hidden" name="LastName" value="'+ user.LastName  +'" />\n';
                            userDetailsText += '<input type="hidden" name="Title" value="'+ user.Title +'" />\n';
                            userDetailsText += '<input type="hidden" name="PhoneExt" value="'+ user.PhoneExt +'" />\n';
                            userDetailsText += '<input type="hidden" name="PhotoPath" value="'+ user.PhotoPath +'" />\n';
                            userDetailsText += '<div class="photo"><img src="'+app.genome.url+user.PhotoPath +'" alt="'+ user.FirstName + ' ' + user.LastName +'" /></div>\n';
                            userDetailsText += '<ul>\n';
                                userDetailsText += '<li class="name"><strong>'+ user.FirstName + ' ' + user.LastName +'</strong></li>\n';
                                userDetailsText += '<li class="position"><strong>Title</strong>: '+ user.Title +'</li>\n';
                                userDetailsText += '<li class="ext"><strong>Phone Ext:</strong> '+ user.PhoneExt +'</li>\n';
                                userDetailsText += '<li class="ext"><strong>Email:</strong> '+ user.Email +'</li>\n';
                                userDetailsText += '<li class="unit"><strong>Team:</strong> '+ user.BusinessUnitName +'</li>\n';
                            userDetailsText += '</ul>\n';
                        userDetailsText += '</div>\n';
                        userDetailsText += '<ul>\n';
                            userDetailsText += '<li class="status"><strong>Status:</strong>\n';
                                userDetailsText += '<select class="form-control" name="Status">\n';
                                    if(user.Status == 'Free'){
                                        userDetailsText += '<option selected="selected" value="Free">Free</option>\n';
                                        userDetailsText += '<option value="Busy">Busy</option>\n';
                                    }
                                    else if(user.Status == 'Busy'){
                                        userDetailsText += '<option value="Free">Free</option>\n';
                                        userDetailsText += '<option selected="selected" value="Busy">Busy</option>\n';
                                    }
                                    else{
                                        userDetailsText += '<option value="Free">Free</option>\n';
                                        userDetailsText += '<option value="Busy">Busy</option>\n';
                                    }
                                userDetailsText += '</select>\n';
                            userDetailsText += '</li>\n';
                            userDetailsText += '<li class="idle-message"><strong>Idle Message:</strong><input class="form-control" type="text" name="Message" value="'+ user.Message +'" placeholder="leave a message..."/></li>\n';
                        userDetailsText += '</ul>\n';

                        var $target = $('#currentuser');
                        var timeSince = getTimeSince(user.TimeStamp);
                        $target.find('h2').html('Your Current Status: <strong>'+ user.Status +'</strong> <span>updated '+ timeSince +' ago</span>');
                        $target.find('.details-container').html(userDetailsText);
                        
                        endAjaxLoad();
                        $target.fadeIn();
                    }
                }     
            }


            //establish connection with Firebase
            function initFirebase(){
                //set up firebase variables from config;
                app.firebase.url = app.config.firebaseUrl;

                //establish firebase connection
                app.firebase.ref = new Firebase(app.firebase.url);
                app.firebase.users = app.firebase.ref.child("users");

                //grab user information from firebase;
                app.firebase.getIdleUsers = function(){
                    app.firebase.ref.on('value', function (snapshot) {
                        //console.log(snapshot.val());
                    }, function (errorObject) {
                        //console.log('The read failed: ' + errorObject.code);
                    });
                }

                //update idle user or add them if they are not in the firebase
                app.firebase.updateUser = function(){
                    var $formfields = $('#currentuser').find('input,select');
                    var userId = $('#currentuser').find('input[name=UserID]').val();                   
                    var userData = {};
                    $formfields.each(function(){
                        var key = $(this).attr('name');
                        var value = $(this).val();
                        userData[key] = value;  
                    });
                    userData['TimeStamp'] = Date.now();
                    //make sure to change this to update when needed;  
                    app.firebase.users.child(userId).set(userData); 

                    var $statusMessage =  $('#currentuser').find('h2');
                    //reset time since update
                    $statusMessage.find('span').fadeOut(function(){
                        $(this).html('updated just now');
                        $(this).fadeIn();
                    });
                    console.log(app.genome.currentUser.Status, userData.Status); 
                    if(app.genome.currentUser.Status != userData.Status ){
                        app.genome.currentUser.Status = userData.Status;
                        $statusMessage.find('strong').fadeOut(function(){
                            $(this).html(userData.Status);
                            $(this).fadeIn();
                        });
                    }


                    // tryCreateUser(userId, userData);
                    // function tryCreateUser(userId, userData) {
                    //     var usersRef = app.firebase.users;
                    //     usersRef.child(userId).transaction(function(currentUserData) {
                    //         if (currentUserData === null){
                    //             return userData;
                    //         }
                    //     }, function(error, committed) {
                    //         if (!committed) {
                    //            app.firebase.users.update(userData.UserID); 
                    //         } 
                    //     });
                    // }
                }

                // app.firebase.getUser = function(id){
                    
                // }
            }

            

            //setup interface bindings for application
            function setupBindings() {
                //do UI bindings
            }

            //create jsonp request call 
            function requestJSON(url) {
               var ajaxCall = $.ajax({
                    url: url,
                    contentType: "application/json",
                    dataType: 'jsonp'
                });
               return ajaxCall;
            }

            

            function getTimeSince(date) {

                var seconds = Math.floor((new Date() - date) / 1000);

                var interval = Math.floor(seconds / 31536000);

                if (interval > 1) {
                    return interval + " years";
                }
                interval = Math.floor(seconds / 2592000);
                if (interval > 1) {
                    return interval + " months";
                }
                interval = Math.floor(seconds / 86400);
                if (interval > 1) {
                    return interval + " days";
                }
                interval = Math.floor(seconds / 3600);
                if (interval > 1) {
                    return interval + " hours";
                }
                interval = Math.floor(seconds / 60);
                if (interval > 1) {
                    return interval + " minutes";
                }
                return Math.floor(seconds) + " seconds";
            }

            //show loader
            function startAjaxLoad(){
                $(app.config.loader).show();
            }
            //fade out loader
            function endAjaxLoad(){
                $(app.config.loader).fadeOut();
            }

            function createGlobalAlert(type, alerttext, duration){
                var alertclass = '';
                var alerthtml = '';
                var $globalalertscontainer = $('#global-alerts');

                if(type == 'error'){
                    alertclass = 'alert-danger';
                }
                else if(type == 'success'){
                    alertclass = 'alert-success';
                }
                
                alerthtml = '<div role="alert" class="alert '+ alertclass +'">'+alerttext+'</div>';
                $globalalertscontainer.find('.alert-container').html(alerthtml)

                $globalalertscontainer
                    .css('opacity', 0)
                    .slideDown('slow')
                    .animate(
                    { opacity: 1 },
                    { queue: false, duration: 'slow', complete: function(){

                        if(duration != null){
                            setTimeout(function(){
                                $globalalertscontainer
                                .slideUp('slow')
                                .animate(
                                  { opacity: 0 },
                                  { queue: false, duration: 'slow' }
                                );
                            }, duration);
                        }
                    }
                });
            }

            return app;
        }(KlickIdle || {} ));
        
        //edit default settings here ex.  app.config.firebaseUrl = 'https://klickidle.firebaseio.com/';
        KlickIdle.init();
   </script>
</body>
</html>